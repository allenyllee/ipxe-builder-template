name: Cleanup iPXE Artifacts

on:
  workflow_run:
    workflows: ["Build iPXE EFI"]
    types: [completed]

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Wait 10 minutes
        run: sleep 600

      - name: Delete `ipxe-efi` artifacts from the run
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const { owner, repo } = context.repo;

            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              { owner, repo, run_id: runId, per_page: 100 }
            );

            const targets = artifacts.filter((a) => a.name === "ipxe-efi");
            if (targets.length === 0) {
              core.info(`No ipxe-efi artifact found for run ${runId}.`);
              return;
            }

            for (const artifact of targets) {
              await github.rest.actions.deleteArtifact({
                owner,
                repo,
                artifact_id: artifact.id,
              });
              core.info(`Deleted artifact ${artifact.id} (${artifact.name}).`);
            }
